<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>闪耀星辰 | 优雅随机点名系统</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        princess: {
                            bg: '#fdf2f8',       // 极浅玫瑰粉 (背景)
                            surface: 'rgba(255, 255, 255, 0.65)', // 玻璃态背景
                            border: '#fbcfe8',   // 柔和粉边框
                            primary: '#ec4899',  // 亮粉色 (主高亮)
                            secondary: '#a855f7',// 丁香紫 (辅色)
                            gold: '#fbbf24',     // 香槟金 (图标/皇冠)
                            text: '#4c1d95',     // 深紫罗兰 (主文本)
                            muted: '#9d174d'     // 柔和深粉 (次文本)
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'serif'],
                        art: ['"Ma Shan Zheng"', 'cursive']
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-15px)' },
                        },
                        glow: {
                            '0%, 100%': { textShadow: '0 0 10px rgba(236,72,153,0.2)' },
                            '50%': { textShadow: '0 0 20px rgba(236,72,153,0.6)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            /* 柔和背景图案：波点/爱心感 */
            .bg-princess-pattern {
                background-color: #fdf2f8;
                background-image: radial-gradient(#fbcfe8 1.5px, transparent 1.5px);
                background-size: 30px 30px;
            }
            
            /* 玻璃态面板 (Glassmorphism) */
            .glass-panel {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.9);
                box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.08);
            }

            /* 自定义柔和滚动条 */
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: transparent; }
            ::-webkit-scrollbar-thumb { 
                background: #fbcfe8; 
                border-radius: 10px; 
            }
            ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        }
    </style>
</head>
<body class="bg-princess-pattern text-princess-text font-serif min-h-screen flex flex-col overflow-hidden relative selection:bg-princess-primary selection:text-white">

    <nav class="w-full z-20 px-8 py-5 flex justify-between items-center glass-panel border-b-0 rounded-b-3xl">
        <div class="flex items-center gap-3">
            <i class="fa fa-star text-princess-gold text-xl animate-pulse"></i>
            <span class="font-art text-2xl tracking-wider text-princess-primary drop-shadow-sm">
                星光 <span class="text-princess-secondary font-serif text-lg">✦ 奇遇</span>
            </span>
        </div>
        
        <div class="flex gap-4">
            <button onclick="App.toggleHistory()" class="group px-5 py-2 glass-panel hover:bg-white rounded-full transition-all flex items-center gap-2 text-sm font-bold shadow-sm hover:shadow-md text-princess-muted">
                <i class="fa fa-book text-princess-secondary group-hover:scale-110 transition-transform"></i>
                <span>回忆相册</span>
            </button>
            <button onclick="App.openSettings()" class="group px-5 py-2 glass-panel hover:bg-white rounded-full transition-all flex items-center gap-2 text-sm font-bold shadow-sm hover:shadow-md text-princess-muted">
                <i class="fa fa-magic text-princess-primary group-hover:scale-110 transition-transform"></i>
                <span>魔法设置</span>
            </button>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center justify-center relative z-10 w-full max-w-5xl mx-auto px-4 mt-8">
        
        <div class="glass-panel rounded-3xl p-6 grid grid-cols-3 gap-12 mb-10 w-full max-w-2xl transform hover:scale-[1.02] transition-transform duration-500">
            <div class="text-center group">
                <div class="text-sm text-princess-muted font-bold tracking-widest mb-2 flex items-center justify-center gap-1">
                    <i class="fa fa-users text-princess-border"></i> 候场仙子
                </div>
                <div class="text-4xl font-bold text-princess-primary font-sans" id="remainCount">00</div>
            </div>
            <div class="text-center group border-x border-princess-border/50">
                <div class="text-sm text-princess-muted font-bold tracking-widest mb-2 flex items-center justify-center gap-1">
                    <i class="fa fa-check-circle-o text-princess-border"></i> 已经登场
                </div>
                <div class="text-4xl font-bold text-princess-secondary font-sans" id="calledCount">00</div>
            </div>
            <div class="text-center group">
                <div class="text-sm text-princess-muted font-bold tracking-widest mb-2 flex items-center justify-center gap-1">
                    <i class="fa fa-heartbeat text-princess-border"></i> 魔法状态
                </div>
                <div class="text-lg font-bold text-princess-primary mt-3" id="systemStatus">等待召唤</div>
            </div>
        </div>

        <div class="relative w-full max-w-3xl flex justify-center mt-4">
            <div id="countdown" class="hidden absolute -top-20 left-1/2 -translate-x-1/2 text-5xl font-sans font-black text-princess-secondary drop-shadow-[0_4px_10px_rgba(168,85,247,0.3)] z-30 tracking-widest">
                00:10:00
            </div>

            <div class="glass-panel rounded-[3rem] w-full max-w-2xl h-72 flex items-center justify-center relative overflow-hidden shadow-[0_20px_50px_-12px_rgba(236,72,153,0.15)] border-2 border-white animate-float">
                <i class="fa fa-quote-left absolute top-8 left-10 text-3xl text-princess-border opacity-50"></i>
                <i class="fa fa-quote-right absolute bottom-8 right-10 text-3xl text-princess-border opacity-50"></i>
                
                <h1 id="nameDisplay" class="relative text-6xl md:text-8xl font-black text-princess-text z-10 transition-all duration-200 tracking-wider">
                    准备就绪
                </h1>
                
                <p id="subStatus" class="absolute bottom-6 text-princess-primary text-sm font-bold tracking-widest opacity-0 transition-opacity duration-500">
                    ✧ 缘分降临 ✧
                </p>
            </div>
        </div>

        <div class="mt-14 flex items-center gap-8 bg-white/40 p-3 rounded-full backdrop-blur-md shadow-sm border border-white/80">
            <div class="flex items-center gap-3 pl-4 pr-2 cursor-pointer group" onclick="document.getElementById('excludeToggle').click()">
                <div class="relative">
                    <input type="checkbox" id="excludeToggle" class="peer sr-only" onchange="App.toggleExclusionMode()">
                    <div class="w-12 h-6 bg-pink-100 border border-princess-border rounded-full peer-checked:bg-princess-primary transition-colors"></div>
                    <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform peer-checked:translate-x-6"></div>
                </div>
                <span class="text-sm font-bold text-princess-muted group-hover:text-princess-primary">不重复召唤</span>
            </div>

            <div class="w-px h-8 bg-princess-border"></div>

            <button id="rollButton" onclick="App.toggleRoll()" class="relative group bg-gradient-to-r from-princess-primary to-princess-secondary text-white px-10 py-3 rounded-full hover:shadow-[0_0_20px_rgba(236,72,153,0.4)] transition-all duration-300 transform hover:-translate-y-1">
                <span class="font-bold text-lg tracking-widest flex items-center gap-2">
                    <i class="fa fa-diamond text-sm"></i> <span id="rollBtnText">开启魔法</span>
                </span>
            </button>

            <div class="w-px h-8 bg-princess-border"></div>

            <button id="countdownBtn" onclick="App.startCountdown()" class="pr-6 pl-2 py-2 text-princess-muted hover:text-princess-primary transition-all flex items-center gap-2 font-bold text-sm group">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm group-hover:bg-princess-bg transition-colors">
                    <i class="fa fa-hourglass-half"></i>
                </div>
                倒计时
            </button>
        </div>

    </main>

    <div id="historyPanel" class="fixed right-0 top-0 h-full w-80 glass-panel border-l border-white shadow-[-10px_0_40px_rgba(236,72,153,0.05)] transform translate-x-full transition-transform duration-500 z-50 flex flex-col rounded-l-3xl">
        <div class="p-6 border-b border-princess-border/50 flex justify-between items-center">
            <h3 class="text-princess-text font-bold text-lg tracking-wider flex items-center gap-2">
                <i class="fa fa-camera-retro text-princess-primary"></i> 奇遇记录
            </h3>
            <button onclick="App.toggleHistory()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-princess-muted hover:text-princess-primary hover:shadow-sm transition-all"><i class="fa fa-times"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto p-4 custom-scrollbar">
            <ul id="historyList" class="space-y-3">
                </ul>
            <div id="emptyHistoryMsg" class="h-full flex flex-col items-center justify-center text-princess-muted/50 text-sm font-bold">
                <i class="fa fa-moon-o text-4xl mb-3 text-princess-border"></i>
                <span>翻开书页，暂无故事...</span>
            </div>
        </div>
        <div class="p-6 border-t border-princess-border/50">
            <button onclick="App.resetHistory()" class="w-full py-3 bg-white border border-pink-200 text-pink-500 rounded-full hover:bg-pink-50 transition-colors text-sm font-bold tracking-widest shadow-sm">
                <i class="fa fa-eraser mr-1"></i> 清空回忆
            </button>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-white/40 backdrop-blur-sm hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-300 shadow-2xl border-2 border-white" id="settingsContent">
            
            <div class="px-6 py-5 border-b border-princess-border/50 flex justify-between items-center bg-white/50">
                <h3 class="font-bold text-princess-text text-lg tracking-wider flex items-center gap-2">
                    <i class="fa fa-sliders text-princess-primary"></i> 魔法配置
                </h3>
                <button onclick="App.closeSettings()" class="text-princess-muted hover:text-princess-primary"><i class="fa fa-times text-lg"></i></button>
            </div>

            <div class="p-8 space-y-8 bg-white/30">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-princess-muted text-sm font-bold tracking-wider">时光沙漏 (秒)</label>
                        <span id="settingDurationDisplay" class="font-sans text-2xl text-princess-primary font-black">10</span>
                    </div>
                    <input type="range" id="settingDurationSlider" min="1" max="60" value="10" class="w-full h-2 bg-pink-100 rounded-full appearance-none cursor-pointer accent-princess-primary">
                    <div class="flex justify-between mt-4 text-xs font-bold text-princess-muted">
                        <button onclick="App.quickSetTime(3)" class="px-3 py-1.5 bg-white rounded-full shadow-sm hover:text-princess-primary transition">3s</button>
                        <button onclick="App.quickSetTime(5)" class="px-3 py-1.5 bg-white rounded-full shadow-sm hover:text-princess-primary transition">5s</button>
                        <button onclick="App.quickSetTime(10)" class="px-3 py-1.5 bg-white rounded-full shadow-sm hover:text-princess-primary transition">10s</button>
                        <button onclick="App.quickSetTime(30)" class="px-3 py-1.5 bg-white rounded-full shadow-sm hover:text-princess-primary transition">30s</button>
                    </div>
                </div>

                <div class="flex justify-between items-center py-2 border-t border-princess-border/50 pt-6">
                    <label class="text-princess-muted text-sm font-bold tracking-wider flex items-center gap-2">
                        <i class="fa fa-music text-princess-secondary"></i> 奇妙音效
                    </label>
                    <div class="relative">
                        <input type="checkbox" id="settingSound" class="peer sr-only">
                        <div class="w-12 h-6 bg-pink-100 rounded-full peer-checked:bg-princess-secondary transition-colors cursor-pointer" onclick="document.getElementById('settingSound').click()"></div>
                        <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform peer-checked:translate-x-6 pointer-events-none"></div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-5 border-t border-princess-border/50 flex justify-end bg-white/50">
                <button onclick="App.saveSettings()" class="px-8 py-2.5 bg-princess-primary hover:bg-pink-400 text-white rounded-full font-bold text-sm transition-all shadow-md hover:shadow-lg tracking-widest">
                    保存咒语
                </button>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="App.toggleHistory()" class="fixed inset-0 bg-transparent hidden z-40"></div>

    <footer class="absolute bottom-4 w-full text-center text-princess-muted/60 text-xs font-bold tracking-widest">
        ✦ PRINCESS EDITION V5.0 ✦
    </footer>

    <script>
        /**
         * 模块化封装，避免全局变量污染 (IIFE模式)
         */
        const App = (function() {
            // --- 核心配置 ---
            const CONFIG = {
                storageKeySettings: 'princessRoll_settings',
                storageKeyHistory: 'princessRoll_history',
                students: [
                    "阿丽米热·如则", "陈贵川", "陈子怡", "关晓旭", "桂子彬", 
                    "何治昊", "胡礼伟", "胡思宇", "黄天乙", "黄莹伟", "金于浩", "金长松", 
                    "孔文杰", "况俊伍", "兰佳澳", "雷贵忠", "李成", "李成斌", "李秦艳", 
                    "李欣杰", "李远松", "林铭乐", "刘净逸", "刘云", "龙浩", "欧阳雨", 
                    "任家友", "孙泽东", "谭国栋", "谭银杰", "唐诗", "万华宇", "王黎宇", 
                    "王倩", "王思力", "王艺颖", "韦韪", "魏杲霈", "翁文韬", "吴茂豪", 
                    "胥杨", "张桂媛", "张辉涛", "张健", "张欣越", "赵俊毅", "朱代君" 
                ]
            };

            // --- 状态管理 ---
            const state = {
                availableStudents: [...CONFIG.students],
                calledStudents: [],
                isRolling: false,
                isCountdown: false,
                timerId: null,
                countdownTimerId: null,
                // 用户配置
                isExclusionMode: false,
                soundEnabled: true,
                countdownDuration: 10
            };

            // --- DOM 缓存 (工程化优化：避免多次查询DOM) ---
            const els = {};

            function initDOM() {
                els.nameDisplay = document.getElementById('nameDisplay');
                els.subStatus = document.getElementById('subStatus');
                els.rollBtnText = document.getElementById('rollBtnText');
                els.rollBtn = document.getElementById('rollButton');
                els.countdownDisplay = document.getElementById('countdown');
                els.countdownBtn = document.getElementById('countdownBtn');
                els.remainCount = document.getElementById('remainCount');
                els.calledCount = document.getElementById('calledCount');
                els.systemStatus = document.getElementById('systemStatus');
                els.historyList = document.getElementById('historyList');
                els.emptyHistoryMsg = document.getElementById('emptyHistoryMsg');
                
                // 面板与设置
                els.modal = document.getElementById('settingsModal');
                els.modalContent = document.getElementById('settingsContent');
                els.durationSlider = document.getElementById('settingDurationSlider');
                els.durationDisplay = document.getElementById('settingDurationDisplay');
                els.soundCheck = document.getElementById('settingSound');
                els.excludeToggle = document.getElementById('excludeToggle');
                els.historyPanel = document.getElementById('historyPanel');
                els.overlay = document.getElementById('overlay');

                // 绑定范围滑动事件
                els.durationSlider.addEventListener('input', (e) => {
                    els.durationDisplay.textContent = e.target.value;
                });
            }

            // --- 音频系统优化 (变更为轻柔的仙女魔法音效) ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            function playTone(type) {
                if (!state.soundEnabled) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const now = audioCtx.currentTime;
                
                if (type === 'tick') {
                    // 清脆的风铃声 (正弦波高频)
                    const osc = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1200 + Math.random() * 200, now);
                    
                    osc.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    gainNode.gain.setValueAtTime(0.08, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                    
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'success') {
                    // 魔法竖琴琵音
                    const playChime = (freq, delay) => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.type = 'sine';
                        o.frequency.value = freq;
                        o.connect(g);
                        g.connect(audioCtx.destination);
                        g.gain.setValueAtTime(0.1, now + delay);
                        g.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.6);
                        o.start(now + delay);
                        o.stop(now + delay + 0.6);
                    };
                    playChime(523.25, 0);    // C5
                    playChime(659.25, 0.1);  // E5
                    playChime(783.99, 0.2);  // G5
                    playChime(1046.50, 0.35); // C6
                }
            }

            // --- 视觉特效优化 (星辰与花瓣纸屑) ---
            function fireMagicConfetti() {
                const colors = ['#f472b6', '#fbbf24', '#e879f9', '#ffffff']; 
                // 左侧发光
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { x: 0.2, y: 0.6 },
                    colors: colors,
                    shapes: ['circle', 'star'], // 变更为可爱的圆和星星
                    scalar: 1.2,
                    gravity: 0.8
                });
                // 右侧发光
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { x: 0.8, y: 0.6 },
                    colors: colors,
                    shapes: ['circle', 'star'],
                    scalar: 1.2,
                    gravity: 0.8
                });
            }

            // --- 核心逻辑 ---
            function loadSettings() {
                try {
                    const savedSettings = JSON.parse(localStorage.getItem(CONFIG.storageKeySettings) || '{}');
                    state.countdownDuration = savedSettings.duration || 10;
                    state.soundEnabled = savedSettings.sound !== undefined ? savedSettings.sound : true;
                    state.isExclusionMode = savedSettings.exclusion !== undefined ? savedSettings.exclusion : false;

                    const savedHistory = JSON.parse(localStorage.getItem(CONFIG.storageKeyHistory) || '[]');
                    state.calledStudents = savedHistory.filter(n => CONFIG.students.includes(n));
                } catch (e) {
                    console.warn("读取本地缓存失败，使用默认配置");
                }

                refreshAvailableList();
                syncUIToState();
            }

            function saveSystemState() {
                localStorage.setItem(CONFIG.storageKeySettings, JSON.stringify({
                    duration: state.countdownDuration,
                    sound: state.soundEnabled,
                    exclusion: state.isExclusionMode
                }));
                localStorage.setItem(CONFIG.storageKeyHistory, JSON.stringify(state.calledStudents));
            }

            function refreshAvailableList() {
                if (state.isExclusionMode) {
                    state.availableStudents = CONFIG.students.filter(n => !state.calledStudents.includes(n));
                } else {
                    state.availableStudents = [...CONFIG.students];
                }
            }

            function syncUIToState() {
                els.excludeToggle.checked = state.isExclusionMode;
                els.durationSlider.value = state.countdownDuration;
                els.durationDisplay.textContent = state.countdownDuration;
                els.soundCheck.checked = state.soundEnabled;
                
                els.remainCount.textContent = state.availableStudents.length.toString().padStart(2, '0');
                els.calledCount.textContent = state.calledStudents.length.toString().padStart(2, '0');
                renderHistory();
            }

            // 安全渲染历史记录 (防御 XSS)
            function renderHistory() {
                els.historyList.innerHTML = ''; // 清空旧数据
                
                if (state.calledStudents.length === 0) {
                    els.emptyHistoryMsg.classList.remove('hidden');
                    return;
                }
                
                els.emptyHistoryMsg.classList.add('hidden');
                
                state.calledStudents.forEach((name, i) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-pink-50 text-sm';
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex items-center gap-3';
                    
                    const indexSpan = document.createElement('span');
                    indexSpan.className = 'w-6 h-6 rounded-full bg-pink-100 text-princess-primary flex items-center justify-center font-bold text-xs font-sans';
                    indexSpan.textContent = state.calledStudents.length - i;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-bold text-princess-text text-base';
                    nameSpan.textContent = name; // 安全的文本插入
                    
                    leftDiv.appendChild(indexSpan);
                    leftDiv.appendChild(nameSpan);
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-xs text-princess-muted/60 font-sans';
                    // 为了演示简化，统一显示当前时间，真实场景可保存抽取时间
                    timeSpan.textContent = new Date().toLocaleTimeString('zh-CN', {hour12: false}).slice(0, 5);
                    
                    li.appendChild(leftDiv);
                    li.appendChild(timeSpan);
                    
                    els.historyList.appendChild(li);
                });
            }

            // 抽离公共结束逻辑 (DRY优化)
            function completeSelection() {
                clearInterval(state.timerId);
                state.timerId = null;
                
                const finalName = els.nameDisplay.textContent;
                els.nameDisplay.classList.add('text-princess-primary', 'scale-110', 'animate-glow');
                els.subStatus.style.opacity = '1';
                
                playTone('success');
                fireMagicConfetti();

                // 更新历史
                if (state.isExclusionMode) {
                    if (!state.calledStudents.includes(finalName)) {
                        state.calledStudents.unshift(finalName);
                    }
                } else {
                    state.calledStudents.unshift(finalName);
                }
                
                refreshAvailableList();
                saveSystemState();
                syncUIToState();
            }

            function resetSystemStatus() {
                state.isRolling = false;
                state.isCountdown = false;
                
                els.rollBtnText.textContent = "开启魔法";
                // 恢复按钮样式
                els.rollBtn.classList.remove('from-gray-400', 'to-gray-500');
                els.rollBtn.classList.add('from-princess-primary', 'to-princess-secondary');
                
                els.systemStatus.textContent = "等待召唤";
                els.systemStatus.className = "text-lg font-bold text-princess-primary mt-3";
                
                els.countdownBtn.disabled = false;
                els.countdownBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                els.countdownDisplay.classList.add('hidden');
            }

            // --- 暴露给全局的方法 ---
            return {
                init: function() {
                    initDOM();
                    loadSettings();
                },

                toggleRoll: function() {
                    if (state.isCountdown) return;
                    
                    if (state.isRolling) {
                        // 停止抽取
                        completeSelection();
                        resetSystemStatus();
                    } else {
                        // 开始抽取
                        if (state.availableStudents.length === 0) {
                            alert("✨ 所有的仙子都已经登场啦！请清空回忆重新开始。");
                            return;
                        }

                        state.isRolling = true;
                        els.rollBtnText.textContent = "魔法结界";
                        
                        // 按钮变灰
                        els.rollBtn.classList.remove('from-princess-primary', 'to-princess-secondary');
                        els.rollBtn.classList.add('from-gray-400', 'to-gray-500');
                        
                        els.systemStatus.textContent = "魔力流转中...";
                        els.systemStatus.className = "text-lg font-bold text-princess-secondary mt-3 animate-pulse";
                        
                        els.nameDisplay.classList.remove('text-princess-primary', 'scale-110', 'animate-glow');
                        els.nameDisplay.classList.add('text-princess-text');
                        els.subStatus.style.opacity = '0';

                        // 防止定时器重叠
                        if(state.timerId) clearInterval(state.timerId);
                        
                        state.timerId = setInterval(() => {
                            const list = state.availableStudents;
                            const idx = Math.floor(Math.random() * list.length);
                            els.nameDisplay.textContent = list[idx];
                            if(Math.random() > 0.6) playTone('tick');
                        }, 50);
                    }
                },

                startCountdown: function() {
                    if (state.isRolling || state.isCountdown) return;
                    if (state.availableStudents.length === 0) {
                        alert("✨ 所有的仙子都已经登场啦！");
                        return;
                    }

                    state.isCountdown = true;
                    state.isRolling = true;
                    
                    els.systemStatus.textContent = "时空倒流...";
                    els.systemStatus.className = "text-lg font-bold text-princess-secondary mt-3 animate-pulse";
                    
                    els.countdownBtn.disabled = true;
                    els.countdownBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    els.countdownDisplay.classList.remove('hidden', 'text-pink-500');
                    els.countdownDisplay.classList.add('text-princess-secondary');
                    
                    let timeLeft = state.countdownDuration;
                    const formatTime = (s) => `00:00:${s < 10 ? '0'+s : s}`;
                    els.countdownDisplay.textContent = formatTime(timeLeft);

                    // 清理文字样式
                    els.nameDisplay.classList.remove('text-princess-primary', 'scale-110', 'animate-glow');
                    els.nameDisplay.classList.add('text-princess-text');
                    els.subStatus.style.opacity = '0';

                    if(state.timerId) clearInterval(state.timerId);
                    if(state.countdownTimerId) clearInterval(state.countdownTimerId);

                    state.timerId = setInterval(() => {
                        const list = state.availableStudents;
                        const idx = Math.floor(Math.random() * list.length);
                        els.nameDisplay.textContent = list[idx];
                    }, 80);

                    state.countdownTimerId = setInterval(() => {
                        timeLeft--;
                        els.countdownDisplay.textContent = formatTime(timeLeft);
                        
                        if (timeLeft <= 3) {
                            playTone('tick');
                            els.countdownDisplay.classList.remove('text-princess-secondary');
                            els.countdownDisplay.classList.add('text-pink-500', 'animate-pulse');
                        }

                        if (timeLeft <= 0) {
                            clearInterval(state.countdownTimerId);
                            completeSelection();
                            resetSystemStatus();
                        }
                    }, 1000);
                },

                toggleExclusionMode: function() {
                    state.isExclusionMode = els.excludeToggle.checked;
                    refreshAvailableList();
                    saveSystemState();
                    syncUIToState();
                },

                // UI 控制相关
                toggleHistory: function() {
                    if (els.historyPanel.classList.contains('translate-x-full')) {
                        els.historyPanel.classList.remove('translate-x-full');
                        els.overlay.classList.remove('hidden');
                    } else {
                        els.historyPanel.classList.add('translate-x-full');
                        els.overlay.classList.add('hidden');
                    }
                },

                resetHistory: function() {
                    if(confirm("✨ 确认要清空所有的奇遇回忆吗？")) {
                        state.calledStudents = [];
                        refreshAvailableList();
                        saveSystemState();
                        syncUIToState();
                    }
                },

                openSettings: function() {
                    els.modal.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        els.modal.classList.remove('opacity-0');
                        els.modalContent.classList.remove('scale-95');
                        els.modalContent.classList.add('scale-100');
                    });
                },

                closeSettings: function() {
                    els.modal.classList.add('opacity-0');
                    els.modalContent.classList.remove('scale-100');
                    els.modalContent.classList.add('scale-95');
                    setTimeout(() => els.modal.classList.add('hidden'), 300);
                },

                quickSetTime: function(val) {
                    els.durationSlider.value = val;
                    els.durationDisplay.textContent = val;
                },

                saveSettings: function() {
                    state.countdownDuration = parseInt(els.durationSlider.value);
                    state.soundEnabled = els.soundCheck.checked;
                    saveSystemState();
                    this.closeSettings();
                }
            };
        })();

        // --- 应用启动 ---
        window.addEventListener('load', App.init);
    </script>
</body>
</html>
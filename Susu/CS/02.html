<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ç²’å­ç³»ç»Ÿ (é›¶ä¾èµ–è°ƒè¯•ç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: monospace; }
        
        /* å±å¹•æ—¥å¿—çª—å£ */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 300px; height: 100%;
            background: rgba(0, 0, 50, 0.8); color: #0f0; padding: 10px;
            overflow-y: auto; z-index: 1000; font-size: 12px;
            border-right: 1px solid #00ffcc; pointer-events: none;
        }
        .log-info { color: #0f0; margin-bottom: 5px; }
        .log-warn { color: #ff0; margin-bottom: 5px; }
        .log-error { color: #f00; font-weight: bold; margin-bottom: 5px; background: #220000; }

        /* è§†é¢‘éšè— */
        #video-input { display: none; }
        
        /* æç¤ºå±‚ */
        #instruction {
            position: absolute; top: 20px; left: 320px; color: white;
            font-size: 1.2rem; pointer-events: none; text-shadow: 0 0 5px black;
        }
    </style>

    <script>
        window.onload = function() {
            const consoleDiv = document.getElementById('debug-console');
            function screenLog(msg, type='info') {
                const div = document.createElement('div');
                div.className = `log-${type}`;
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                consoleDiv.appendChild(div);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
            window.screenLog = screenLog; // æŒ‚è½½åˆ°å…¨å±€

            // æ£€æŸ¥æ˜¯ä¸æ˜¯ file:// åè®®
            if (window.location.protocol === 'file:') {
                screenLog("âŒ ä¸¥é‡é”™è¯¯: æ£€æµ‹åˆ° file:// åè®®", 'error');
                screenLog("è¯·å‹¿ç›´æ¥åŒå‡»æ‰“å¼€ HTML æ–‡ä»¶ï¼", 'error');
                screenLog("å¿…é¡»ä½¿ç”¨ VS Code Live Server æˆ–æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€ã€‚", 'error');
                alert("è¯·ä¸è¦ç›´æ¥åŒå‡»æ‰“å¼€ï¼è¯·ä½¿ç”¨ VS Code çš„ Live Server æ’ä»¶è¿è¡Œã€‚");
            } else {
                screenLog("âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡: HTTPåè®®å·²å¯ç”¨");
            }
        };
        
        window.onerror = function(msg, source, lineno) {
            if(window.screenLog) window.screenLog(`å…¨å±€é”™è¯¯: ${msg} (è¡Œ:${lineno})`, 'error');
        }
    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://npm.elemecdn.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://npm.elemecdn.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="debug-console">
        <div>=== ç³»ç»Ÿæ—¥å¿— (æˆªå›¾å‘ç»™å¼€å‘è€…) ===</div>
    </div>
    
    <div id="instruction">
        å½“å‰æ¨¡å¼ï¼šåŸºç¡€å½¢çŠ¶ (é¼ æ ‡æŒ‰ä½æ¶ˆæ•£ / æ¾å¼€èšé›†)<br>
        <span style="font-size:0.8rem; color:#aaa">æ­£åœ¨åå°å°è¯•åŠ è½½å­—ä½“å’Œæ‘„åƒå¤´...</span>
    </div>
    
    <video id="video-input"></video>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import GUI from 'three/addons/libs/lil-gui.module.min.js';

        // ç«‹å³è®°å½•
        window.screenLog("ğŸš€ è„šæœ¬å¼€å§‹æ‰§è¡Œ...");

        // === å˜é‡ ===
        let scene, camera, renderer, particles;
        let targetPositions = [];
        let font = null;
        let isHandMode = false;
        let handClosed = false;
        let isMouseDown = false;
        
        const config = {
            particleColor: '#00ffcc',
            particleSize: 0.2,
            lerpSpeed: 0.1
        };

        // === 1. åˆå§‹åŒ–åœºæ™¯ (ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…) ===
        try {
            initScene();
            window.screenLog("âœ… Three.js åœºæ™¯åˆå§‹åŒ–æˆåŠŸ");
            // ç«‹å³åˆ›å»ºä¸€ä¸ªç«‹æ–¹ä½“ï¼Œç¡®ä¿å±å¹•ä¸Šæœ‰ä¸œè¥¿
            createShape('box'); 
            animate();
            window.screenLog("âœ… åŠ¨ç”»å¾ªç¯å·²å¯åŠ¨");
        } catch (e) {
            window.screenLog(`âŒ åˆå§‹åŒ–å´©æºƒ: ${e.message}`, 'error');
        }

        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 20;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // äº¤äº’äº‹ä»¶
            document.addEventListener('mousedown', () => isMouseDown = true);
            document.addEventListener('mouseup', () => isMouseDown = false);
            document.addEventListener('touchstart', () => isMouseDown = true);
            document.addEventListener('touchend', () => isMouseDown = false);
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // === 2. ç²’å­ç”Ÿæˆå™¨ ===
        function createShape(type, textStr = '') {
            if (particles) {
                scene.remove(particles);
                if(particles.geometry) particles.geometry.dispose();
            }

            let geo;
            const count = 3000;

            if (type === 'text' && font) {
                geo = new TextGeometry(textStr, {
                    font: font, size: 3, height: 0.2, curveSegments: 6
                });
                geo.center(); // å±…ä¸­
            } else {
                // é»˜è®¤å½¢çŠ¶ï¼šç«‹æ–¹ä½“
                geo = new THREE.BoxGeometry(10, 10, 10, 10, 10, 10);
                if (type === 'sphere') geo = new THREE.SphereGeometry(6, 32, 32);
                window.screenLog(`â„¹ï¸ ç”ŸæˆåŸºç¡€å½¢çŠ¶: ${type}`);
            }

            // æå–ç›®æ ‡ç‚¹
            const posAttr = geo.attributes.position;
            targetPositions = [];
            for(let i=0; i<count; i++) {
                const idx = i % posAttr.count;
                targetPositions.push(posAttr.getX(idx), posAttr.getY(idx), posAttr.getZ(idx));
            }

            // ç²’å­ç³»ç»Ÿ
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            for(let i=0; i<count * 3; i++) positions[i] = (Math.random() - 0.5) * 60; // éšæœºåˆå§‹ä½
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: config.particleColor,
                size: config.particleSize,
                transparent: true, opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // === 3. åŠ¨ç”» ===
        function animate() {
            requestAnimationFrame(animate);
            
            if (!particles) return;
            
            // åˆ¤æ–­æ˜¯å¦åˆ†æ•£ï¼šæ‰‹åŠ¿é—­åˆ OR é¼ æ ‡æŒ‰ä¸‹
            const disperse = isHandMode ? handClosed : isMouseDown;
            const time = Date.now() * 0.001;
            
            const positions = particles.geometry.attributes.position.array;
            
            for(let i=0; i<positions.length; i+=3) {
                const px = positions[i];
                const py = positions[i+1];
                const pz = positions[i+2];
                
                const tx = targetPositions[i];
                const ty = targetPositions[i+1];
                const tz = targetPositions[i+2];
                
                let vx, vy, vz;
                
                if (disperse) {
                    // ç‚¸å¼€æ•ˆæœ
                    vx = px * 0.05 + Math.sin(py + time) * 0.1;
                    vy = py * 0.05 + Math.cos(px + time) * 0.1;
                    vz = pz * 0.05;
                } else {
                    // èšæ‹¢æ•ˆæœ
                    vx = (tx - px) * config.lerpSpeed;
                    vy = (ty - py) * config.lerpSpeed;
                    vz = (tz - pz) * config.lerpSpeed;
                }
                
                positions[i] += vx;
                positions[i+1] += vy;
                positions[i+2] += vz;
            }
            
            particles.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // === 4. å¼‚æ­¥åŠ è½½èµ„æº (ä¸é˜»å¡ä¸»æµç¨‹) ===
        
        // (A) åŠ è½½å­—ä½“
        window.screenLog("â³ å¼€å§‹åå°åŠ è½½å­—ä½“...");
        const loader = new FontLoader();
        loader.load('https://npm.elemecdn.com/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', 
            (res) => {
                font = res;
                window.screenLog("âœ… å­—ä½“åŠ è½½æˆåŠŸ! åˆ‡æ¢ä¸ºæ–‡å­—æ¨¡å¼");
                createShape('text', 'Hello!');
                initGUI(); // æœ‰å­—ä½“äº†å†æ˜¾ç¤ºGUI
            },
            undefined,
            (err) => window.screenLog("âš ï¸ å­—ä½“åŠ è½½å¤±è´¥(å¯èƒ½æ˜¯ç½‘ç»œ)ï¼Œä¿æŒå½¢çŠ¶æ¨¡å¼", 'warn')
        );

        // (B) åŠ è½½æ‘„åƒå¤´ AI
        window.screenLog("â³ å¼€å§‹åå°åŠ è½½ MediaPipe AI...");
        try {
            const videoElement = document.getElementById('video-input');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0 });
            hands.onResults((results) => {
                if(!isHandMode) {
                    isHandMode = true;
                    window.screenLog("âœ… æ‘„åƒå¤´/æ‰‹åŠ¿è¯†åˆ«å·²æ¿€æ´»!", 'info');
                    document.getElementById('instruction').innerText = "æ‰‹åŠ¿æ§åˆ¶ï¼šå¼ å¼€æ‰‹=èšé›†ï¼Œæåˆæ‰‹=æ¶ˆæ•£";
                }
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    const d = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                    handClosed = d < 0.08;
                }
            });

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 640, height: 480
            });
            cameraUtils.start().catch(e => window.screenLog(`âš ï¸ æ‘„åƒå¤´æ— æ³•å¯åŠ¨: ${e}`, 'warn'));
            
        } catch(e) {
            window.screenLog(`âš ï¸ MediaPipe åˆå§‹åŒ–å¤±è´¥: ${e}`, 'warn');
        }

        function initGUI() {
            const gui = new GUI();
            const params = { text: 'Merry Christmas' };
            gui.add(params, 'text').onChange(v => createShape('text', v));
            gui.addColor(config, 'particleColor').onChange(v => particles.material.color.set(v));
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js æ‰‹åŠ¿å¼•åŠ›åœº</title>
    <style>
        :root {
            --primary: #00f2ff;
            --accent: #ff0055;
            --panel: rgba(15, 15, 20, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; overflow: hidden; background: #000;
            font-family: 'Segoe UI', sans-serif; color: white;
            user-select: none;
        }

        /* è§†é¢‘éšè—ï¼Œåªåšè®¡ç®— */
        #video-input { display: none; transform: scaleX(-1); }

        /* ç”»å¸ƒ */
        #canvas-container {
            position: absolute; inset: 0; z-index: 1;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        /* UI é¢æ¿ */
        #ui-panel {
            position: absolute; top: 20px; right: 20px; width: 260px;
            background: var(--panel);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }

        h2 {
            margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase;
            letter-spacing: 2px; color: var(--primary); text-align: center;
            border-bottom: 1px solid var(--border); padding-bottom: 10px;
        }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }

        button {
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
            color: #aaa; padding: 8px 0; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: 0.2s;
        }
        button:hover { background: rgba(255,255,255,0.1); color: #fff; }
        button.active {
            background: rgba(0, 242, 255, 0.15); color: var(--primary);
            border-color: var(--primary); font-weight: bold;
        }

        /* é¢œè‰²é€‰æ‹© */
        .color-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; font-size: 12px; color: #888;
        }
        input[type="color"] {
            width: 50px; height: 25px; border: none; background: none; cursor: pointer;
        }

        /* çŠ¶æ€æŒ‡ç¤º */
        #status-bar {
            padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;
            font-size: 12px; text-align: center; border-left: 3px solid #555;
            transition: 0.3s;
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-bar {
            width: 150px; height: 2px; background: #333; margin-top: 15px; overflow: hidden;
        }
        .loading-progress {
            width: 100%; height: 100%; background: var(--primary);
            transform: translateX(-100%); animation: load 2s infinite ease-in-out;
        }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>

    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px;">âœ‹</div>
    <div class="loading-bar"><div class="loading-progress"></div></div>
    <p style="color:#666; font-size:12px; margin-top:10px;">å¯åŠ¨æ‰‹åŠ¿è¿½è¸ªå¼•æ“...</p>
</div>

<div id="ui-panel">
    <h2>ç²’å­å¼•åŠ›åœº</h2>
    
    <div class="btn-group">
        <button onclick="setMode('heart')" class="active" id="btn-heart">â¤ï¸ æ ¸å¿ƒ</button>
        <button onclick="setMode('sphere')" id="btn-sphere">ğŸ”® çµçƒ</button>
        <button onclick="setMode('vortex')" id="btn-vortex">ğŸŒ€ æ¼©æ¶¡</button>
        <button onclick="setMode('cube')" id="btn-cube">ğŸ§Š çŸ©é˜µ</button>
        <button onclick="setMode('dna')" id="btn-dna">ğŸ§¬ èºæ—‹</button>
        <button onclick="setMode('atomic')" id="btn-atomic">âš›ï¸ åŸå­</button>
    </div>

    <div class="color-wrapper">
        <span>ç²’å­é¢œè‰²</span>
        <input type="color" id="colorPicker" value="#00f2ff">
    </div>

    <div id="status-bar">
        ç­‰å¾…æ‰‹åŠ¿...
    </div>
</div>

<video id="video-input"></video>
<div id="canvas-container"></div>

<script>
    // --- 1. Three.js åˆå§‹åŒ– ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.001); // é»‘è‰²æ·±åº¦é›¾

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 60; // ç¨å¾®æ‹‰è¿œä¸€ç‚¹

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    // --- 2. ç²’å­ä¸å½¢çŠ¶ç³»ç»Ÿ ---
    const PARTICLE_COUNT = 18000;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    
    // æ ¸å¿ƒæ•°æ®ç»“æ„
    // homePositions: ç²’å­åœ¨å…¨å±æ¨¡å¼ä¸‹çš„â€œå®¶â€ï¼ˆéšæœºåˆ†å¸ƒåœ¨å±å¹•ç©ºé—´ï¼‰
    // shapeOffsets:  ç²’å­åœ¨å‡èšæ¨¡å¼ä¸‹ï¼Œç›¸å¯¹äºæ‰‹å¿ƒçš„â€œåç§»é‡â€
    const homePositions = new Float32Array(PARTICLE_COUNT * 3);
    const shapeOffsets = {
        sphere: [], heart: [], vortex: [], cube: [], dna: [], atomic: []
    };

    // å·¥å…·ï¼šéšæœºçƒé¢ç‚¹
    const getSpherePoint = (r) => {
        const u = Math.random(), v = Math.random();
        const theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1);
        return {
            x: r * Math.sin(phi) * Math.cos(theta),
            y: r * Math.sin(phi) * Math.sin(theta),
            z: r * Math.cos(phi)
        };
    };

    // åˆå§‹åŒ–æ•°æ®
    function initParticles() {
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            // 1. åˆå§‹åŒ– Home (å…¨å±èƒŒæ™¯) - å®½å¹¿åˆ†å¸ƒ
            const hx = (Math.random() - 0.5) * 200;
            const hy = (Math.random() - 0.5) * 120;
            const hz = (Math.random() - 0.5) * 100;
            homePositions[i*3] = hx;
            homePositions[i*3+1] = hy;
            homePositions[i*3+2] = hz;
            
            // åˆå§‹ä½ç½®è®¾ä¸º Home
            positions[i*3] = hx;
            positions[i*3+1] = hy;
            positions[i*3+2] = hz;

            // 2. é¢„è®¡ç®—å„ç§å½¢çŠ¶åç§»
            
            // Heart
            let t = Math.random() * Math.PI * 2;
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
            let z = (Math.random()-0.5)*4;
            let s = Math.random(); // å¡«å……
            shapeOffsets.heart.push(x*s*1.2, (y*s*1.2)+2, z*s);

            // Sphere
            let p = getSpherePoint(12);
            shapeOffsets.sphere.push(p.x, p.y, p.z);

            // Vortex (Galaxy)
            let angle = Math.random() * Math.PI * 2 * 3;
            let r = Math.random() * 20;
            shapeOffsets.vortex.push(
                Math.cos(angle + r*0.2) * r,
                (Math.random()-0.5) * (20-r) * 0.5,
                Math.sin(angle + r*0.2) * r
            );

            // Cube
            let edge = 20;
            shapeOffsets.cube.push(
                (Math.random()-0.5)*edge, (Math.random()-0.5)*edge, (Math.random()-0.5)*edge
            );

            // DNA
            let h = (Math.random()-0.5)*40;
            let rot = h*0.4;
            let offset = (i%2===0)?0:Math.PI;
            shapeOffsets.dna.push(
                Math.cos(rot+offset)*6, h, Math.sin(rot+offset)*6
            );

            // Atomic
            let atomR = 12;
            // 3ä¸ªè½¨é“ ring
            let ring = i % 3; 
            let alpha = Math.random() * Math.PI * 2;
            if(ring===0) { x=Math.cos(alpha)*atomR; y=Math.sin(alpha)*atomR; z=0; }
            if(ring===1) { x=Math.cos(alpha)*atomR; y=0; z=Math.sin(alpha)*atomR; }
            if(ring===2) { x=0; y=Math.cos(alpha)*atomR; z=Math.sin(alpha)*atomR; }
            // æ ¸å¿ƒ
            if(Math.random()>0.8) { x*=0.2; y*=0.2; z*=0.2; } // 20%ç²’å­åœ¨æ ¸å†…
            shapeOffsets.atomic.push(x, y, z);
        }
    }
    
    initParticles();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    // æè´¨
    const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png');
    const material = new THREE.PointsMaterial({
        size: 0.6,
        color: 0x00f2ff,
        map: sprite,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    // --- 3. äº¤äº’é€»è¾‘çŠ¶æ€ ---
    let currentShapeData = shapeOffsets.heart;
    
    // Hand State
    let handPos = new THREE.Vector3(0, 0, 0); // åŸå§‹æ£€æµ‹åæ ‡
    let smoothedHandPos = new THREE.Vector3(0, 0, 0); // å¹³æ»‘åçš„æ¸²æŸ“åæ ‡
    
    // interactionLevel: 0 = è‡ªç”±/å…¨å±, 1 = æŒæ§/èšæ‹¢
    // æˆ‘ä»¬ç”¨å¹³æ»‘è¿‡æ¸¡æ¥å®ç°
    let interactionLevel = 0; 
    let isHandPresent = false;

    // UI Controls
    window.setMode = (mode) => {
        currentShapeData = shapeOffsets[mode];
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+mode).classList.add('active');
    };
    document.getElementById('colorPicker').addEventListener('input', (e) => material.color.set(e.target.value));

    // --- 4. è§†è§‰è¯†åˆ« (MediaPipe) ---
    const statusBar = document.getElementById('status-bar');

    function onResults(results) {
        document.getElementById('loader').style.display = 'none';

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            isHandPresent = true;
            const landmarks = results.multiHandLandmarks[0];

            // è®¡ç®—æ‰‹çš„ä½ç½® (é•œåƒå¤„ç† + åæ ‡æ˜ å°„)
            // å±å¹•ä¸­å¿ƒ (0.5, 0.5) -> ä¸–ç•Œ (0, 0)
            const x = (0.5 - landmarks[9].x) * 110; // å®½å¹…
            const y = (0.5 - landmarks[9].y) * 70;  // é«˜å¹…
            handPos.set(x, y, 0);

            // è®¡ç®—æåˆ (æ‹‡æŒ‡4 - é£ŸæŒ‡8)
            const d = Math.sqrt(
                Math.pow(landmarks[4].x - landmarks[8].x, 2) + 
                Math.pow(landmarks[4].y - landmarks[8].y, 2)
            );

            // é€»è¾‘: 
            // æåˆ (d < 0.05) -> Level 1 (èšæ‹¢)
            // å¼ å¼€ (d > 0.15) -> Level 0 (å…¨å±)
            let targetLevel = (0.15 - d) * 10; // ç®€å•çš„çº¿æ€§æ˜ å°„
            targetLevel = Math.max(0, Math.min(1, targetLevel)); // Clamp 0-1

            // çŠ¶æ€å¹³æ»‘
            interactionLevel += (targetLevel - interactionLevel) * 0.15;

            // UI åé¦ˆ
            if (interactionLevel > 0.6) {
                statusBar.innerText = "âš¡ æŒæ§ä¸­ (è·Ÿéšç§»åŠ¨)";
                statusBar.style.borderLeftColor = "#00ff88";
                statusBar.style.color = "#00ff88";
            } else {
                statusBar.innerText = "âœ¨ é‡Šæ”¾ä¸­ (å…¨å±æ‰©æ•£)";
                statusBar.style.borderLeftColor = "#00f2ff";
                statusBar.style.color = "#fff";
            }

        } else {
            isHandPresent = false;
            // æ— æ‰‹æ—¶ï¼Œlevel å½’é›¶
            interactionLevel += (0 - interactionLevel) * 0.05;
            statusBar.innerText = "ç­‰å¾…æ‰‹éƒ¨è¿›å…¥...";
            statusBar.style.borderLeftColor = "#555";
            statusBar.style.color = "#888";
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
    hands.onResults(onResults);
    
    const cam = new Camera(document.getElementById('video-input'), {
        onFrame: async () => await hands.send({image: document.getElementById('video-input')}),
        width: 640, height: 480
    });
    cam.start();

    // --- 5. åŠ¨ç”»å¾ªç¯ (æ ¸å¿ƒç‰©ç†é€»è¾‘) ---
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        
        // 1. æ‰‹éƒ¨ä½ç½®å¹³æ»‘ (å¢åŠ æƒ¯æ€§)
        smoothedHandPos.lerp(handPos, 0.12);

        // 2. åœºæ™¯æ—‹è½¬
        // èšæ‹¢æ—¶è½¬å¾—å¿«ï¼Œæ•£å¼€æ—¶è½¬å¾—æ…¢
        const rotSpeed = 0.02 + interactionLevel * 0.05;
        particles.rotation.y += rotSpeed;
        // éšæ‰‹ä¸Šä¸‹å€¾æ–œä¸€ç‚¹åœºæ™¯
        particles.rotation.x = smoothedHandPos.y * 0.005;

        const pArr = particles.geometry.attributes.position.array;

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const idx = i * 3;

            // --- çŠ¶æ€ A: å…¨å±è‡ªç”±æ€ (Home) ---
            // åŠ ä¸Šæ­£å¼¦æ³¢ï¼Œè®©ç²’å­åœ¨èƒŒæ™¯é‡Œâ€œå‘¼å¸â€
            const hx = homePositions[idx];
            const hy = homePositions[idx+1];
            const hz = homePositions[idx+2];
            
            // æ‰°åŠ¨è®¡ç®—ï¼šå¦‚æœæ‰‹åœ¨ç§»åŠ¨ï¼ˆinteractionLevelä½ï¼Œä½†isHandPresentï¼‰ï¼Œæ¨å¼€é™„è¿‘çš„ç²’å­
            let worldX = hx;
            let worldY = hy;
            let worldZ = hz;

            if (isHandPresent && interactionLevel < 0.3) {
                // è®¡ç®—ç²’å­åˆ°æ‰‹çš„è·ç¦»
                const dx = hx - smoothedHandPos.x;
                const dy = hy - smoothedHandPos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                // ç®€å•çš„æ’æ–¥åœº (æ‰‹ç»è¿‡æ—¶ç²’å­æ•£å¼€)
                if (dist < 20) {
                    const force = (20 - dist) * 0.5;
                    worldX += (dx / dist) * force;
                    worldY += (dy / dist) * force;
                }
            }

            // --- çŠ¶æ€ B: èšæ‹¢è·Ÿéšæ€ (Target) ---
            const sx = smoothedHandPos.x + currentShapeData[i];
            const sy = smoothedHandPos.y + currentShapeData[i+1];
            const sz = smoothedHandPos.z + currentShapeData[i+2];

            // --- æœ€ç»ˆä½ç½®æ··åˆ (Lerp) ---
            // interactionLevel å†³å®šäº†æˆ‘ä»¬æ˜¯åœ¨ A è¿˜æ˜¯ Bï¼Œæˆ–è€…ä¸­é—´
            // 0 = A, 1 = B
            
            // è®¡ç®—ç›®æ ‡ç‚¹
            const targetX = worldX + (sx - worldX) * interactionLevel;
            const targetY = worldY + (sy - worldY) * interactionLevel;
            const targetZ = worldZ + (sz - worldZ) * interactionLevel;

            // ç§»åŠ¨ç²’å­ (Ease)
            // èšæ‹¢æ—¶å“åº”å¿«(0.15)ï¼Œæ•£å¼€æ—¶å“åº”æ…¢(0.05)æœ‰é£˜æ•£æ„Ÿ
            const ease = 0.05 + interactionLevel * 0.1;
            
            pArr[idx]   += (targetX - pArr[idx])   * ease;
            pArr[idx+1] += (targetY - pArr[idx+1]) * ease;
            pArr[idx+2] += (targetZ - pArr[idx+2]) * ease;
        }

        // åŠ¨æ€å¤§å°
        // æ•£å¼€æ—¶å°(æ˜Ÿæ˜Ÿ)ï¼Œèšæ‹¢æ—¶å¤§(èƒ½é‡)
        material.size = 0.5 + interactionLevel * 0.5;

        particles.geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
    }

    // çª—å£è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>